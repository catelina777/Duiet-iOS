default_platform :ios

platform :ios do

  desc 'Run Duiet.app tests'
  lane :duiet_tests do
    run_test("Duiet.xcworkspace", 'DuietTests', 'name=iPhone Xs Max,OS=12.4', 'DuietTests')
    run_test("Duiet.xcworkspace", 'DuietUITests', 'name=iPhone Xs Max,OS=12.4', 'DuietUITests')
  end

  def run_test(workspace, scheme, destination, testcase)
    Dir.chdir("#{ENV['PWD']}") do
      sh "set -o pipefail && xcodebuild -alltargets clean"
      sh "set -o pipefail && xcodebuild test -workspace #{workspace} -scheme #{scheme} -destination '#{destination}' -only-testing:#{testcase} -derivedDataPath DerivedData -enableCodeCoverage YES ENABLE_TESTABILITY=YES | xcpretty"
    end
  end


  desc 'Update dependencies managed by CocoaPods and Carthage'
  lane :update_dependencies do
    Dir.chdir("#{ENV['PWD']}") do
      sh 'bundle exec pod update'
      sh 'carthage update --platform ios --configuration Release --cache-builds'

      unless system('git diff --quiet --exit-code')
        system('git add Podfile.lock')
        system('git add Cartfile.resolved')
        commit_push_create_pr(branch_name: "ci/update-dependencies-#{Time.now.to_i}", message: 'Update dependencies managed by CocoaPods and Carthage')
      end
    end
  end

  lane :update_tools do
    Dir.chdir("#{ENV['PWD']}") do
      sh 'bundle update'

      unless system('git diff --quiet --exit-code')
        sh 'git add Gemfile.lock'
        commit_push_create_pr(branch_name: "ci/update-tools-#{Time.now.to_i}", message: 'Update developer tools')
      end
    end
  end

  lane :update_license_list do
    github_token = ENV['GITHUB_ACCESS_TOKEN']
    Dir.chdir("#{ENV['PWD']}") do
      sh "Pods/LicensePlist/license-plist --force --output-path Duiet/Resources/Settings/Settings.bundle --github-token #{github_token} --suppress-opening-directory"

      unless system('git diff --quiet --exit-code')
        sh 'git add Duiet/Resources/Settings/Settings.bundle/'
        commit_push_create_pr(branch_name: "ci/update-license-#{Time.now.to_i}", message: 'Update license list')
      end
    end
  end

  def commit_push_create_pr(branch_name: "", message: "")
    sh "git checkout -b #{branch_name}"
    sh "git commit -m '#{message}'"
    sh 'git push origin HEAD'
    create_pull_request(
      api_token: ENV['GITHUB_ACCESS_TOKEN'],
      repo: "catelina777/Duiet-iOS",
      title: message,
      head: branch_name,
      body: "This PR was generated by fastlane ðŸš€"
    )
  end
end
